<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ .Title }} | {{ .Site.Params.companyName }}</title>
    <link rel="stylesheet" href="{{ "css/style.css" | relURL }}">
    <meta charset="UTF-8">
    <title>{{ .Title }} | {{ .Site.Params.companyName }}</title>
    <link rel="stylesheet" href="{{ "css/style.css" | relURL }}">
    
    <link rel="stylesheet" href="{{ "css/product-slideshow.css" | relURL }}">

    <link rel="stylesheet" href="{{ "/css/floating.css" | relURL }}">
    <link rel="stylesheet" href="{{ "/css/searchbar.css" | relURL }}">
    <link rel="stylesheet" href="{{ "/css/quickAdd.css" | relURL }}">
    {{ if or (eq .RelPermalink "/about/") (eq .RelPermalink "/about") }}
    <link rel="stylesheet" href="{{ "css/about.css" | relURL }}">
    {{ end }}
</head>
<body>
    
    {{ partial "header.html" . }}

    <script>
        // Define the logic once
        function forceUpdateCart() {
            try {
                // 1. Get Cart Data
                const cart = JSON.parse(localStorage.getItem('myShopCart')) || [];
                const totalQty = cart.reduce((sum, item) => sum + parseInt(item.quantity || 0), 0);
                
                // 2. Find the Badge
                const cartBadge = document.getElementById('cart-count');
                
                // 3. Update if badge exists
                if (cartBadge) {
                    cartBadge.innerText = totalQty;
                    // Debugging log to see if it works
                    // console.log("Cart updated to:", totalQty); 
                }
            } catch (e) {
                console.error("Cart Count Error:", e);
            }
        }

        // === EXECUTION ORDER ===
        
        // 1. Run immediately (As soon as HTML exists)
        document.addEventListener('DOMContentLoaded', forceUpdateCart);

        // 2. Run again when page is fully loaded (Overrides other scripts)
        window.addEventListener('load', forceUpdateCart);

        // 3. Run one last time after 500ms (The "Anti-Blink" Fix)
        // This waits half a second to overwrite any script that tried to set it to 0
        setTimeout(forceUpdateCart, 20);
    </script>
    <main>
        {{ block "main" . }}{{ end }}
    </main>

    {{ partial "footer.html" . }}

    <script src="/js/script.js"></script>
    <script src="/js/slideshow.js"></script>

    <script>
    function quickAdd(event, product) {
        // QUAN TRỌNG: Chặn không cho nhảy vào trang chi tiết sản phẩm
        event.preventDefault(); 
        event.stopPropagation();

        let cart = JSON.parse(localStorage.getItem('myShopCart')) || [];
        let existingItem = cart.find(item => item.id === product.id);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            product.quantity = 1;
            cart.push(product);
        }

        localStorage.setItem('myShopCart', JSON.stringify(cart));
        
        // Cập nhật số trên icon giỏ hàng (nếu có hàm này)
        if (typeof updateCartCount === 'function') { updateCartCount(); }

        updateCartCount();  // <== Gọi nó chạy ngay lập tức

        // Thông báo nhỏ
        alert('Đã thêm "' + product.title + '" vào giỏ!');
    }
</script>

<script>
    // Hàm cập nhật số lượng trên icon giỏ hàng
    function updateCartCount() {
        // 1. Lấy giỏ hàng ra
        let cart = JSON.parse(localStorage.getItem('myShopCart')) || [];
        
        // 2. Tính tổng số lượng (Cộng dồn quantity của từng món)
        let totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);

        // 3. Tìm cái thẻ hiển thị số và cập nhật
        let countEl = document.getElementById('cart-count');
        if (countEl) {
            countEl.innerText = totalQty;
            
            // (Tuỳ chọn) Nếu giỏ hàng trống thì ẩn số 0 đi cho đẹp
            if (totalQty > 0) {
                countEl.style.display = 'inline-flex'; // Hoặc 'block'
            } else {
                // countEl.style.display = 'none'; // Bỏ comment dòng này nếu muốn ẩn số 0
            }
        }
    }

    // Chạy hàm này ngay khi web vừa tải xong (để hiển thị số cũ)
    document.addEventListener('DOMContentLoaded', updateCartCount);
</script>

</body>
</html>