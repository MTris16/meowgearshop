{{ define "main" }}
<div class="product-detail-container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    
    <div class="product-content-wrapper" style="display: flex; flex-wrap: wrap; gap: 40px; align-items: flex-start;">
        
    <div class="product-images" style="flex: 1 1 400px; max-width: 100%;">
        
        <div class="main-image-wrapper" style="position: relative;">
            {{ if .Params.images.main }}
                <img id="main-img" src="{{ .Params.images.main | relURL }}" alt="{{ .Title }}">
                
                <button class="nav-btn prev" onclick="plusSlides(-1)">&#10094;</button>
                <button class="nav-btn next" onclick="plusSlides(1)">&#10095;</button>
            {{ else }}
                <div class="no-image-placeholder">No Image</div>
            {{ end }}
        </div>

        <div class="thumbnails-wrapper">
            {{ if .Params.images.main }}
                <img class="thumb active" 
                    src="{{ .Params.images.main | relURL }}" 
                    onclick="currentSlide(0)">
            {{ end }}

            {{ range $index, $element := .Params.images.thumbs }}
                <img class="thumb" 
                    src="{{ . | relURL }}" 
                    onclick="currentSlide({{ add $index 1 }})">
            {{ end }}
        </div>

</div>

        <div class="product-info-section" style="flex: 1 1 400px; min-width: 0;">
            
            <h1 style="margin-top: 0; font-size: 28px; color: #333; line-height: 1.3; white-space: normal !important; overflow-wrap: break-word; word-break: break-word;">
                {{ .Title }}
            </h1>

            <div class="product-price">
                {{ $finalPrice := or .Params.price .Params.price_new }}
                
                <span class="price-new">
                    {{ $finalPrice }}
                    {{ if not (findRE "₫|đ" $finalPrice) }}₫{{ end }}
                </span>
                
                {{ if .Params.price_old }}
                    <span class="price-old">{{ .Params.price_old }}</span>
                {{ end }}
            </div>

            <div class="product-short-desc warning-box">
                <strong>Lưu ý quan trọng</strong>
                {{ .Params.short_desc | markdownify }}
            </div>

            <div class="add-to-cart-wrapper">
                <button 
                    class="add-to-cart-button" 
                    onclick='addToCart({
                        id: "{{ .RelPermalink }}", 
                        title: "{{ .Title }}",
                        image: "{{ .Params.images.main | relURL }}",
                        price: {{ replace (replace (replace $finalPrice "₫" "") "đ" "") "." "" | default 0 }},
                        quantity: 1
                    })'
                >
                    Thêm vào giỏ
                </button>
            </div>
            
        </div>
        
    </div>
    
    <div class="product-full-details" style="margin-top: 50px; padding-top: 30px; border-top: 1px solid #eee;">
        <div class="product-specs" style="margin-bottom: 40px;">
            <h2 style="font-size: 22px; border-bottom: 2px solid #ff5722; display: inline-block; padding-bottom: 5px; margin-bottom: 20px;">Thông số kỹ thuật</h2>
            <div style="line-height: 1.6;">
                {{ .Params.specs | markdownify }}
            </div>
        </div>

        <div class="product-description">
            <h2 style="font-size: 22px; border-bottom: 2px solid #ff5722; display: inline-block; padding-bottom: 5px; margin-bottom: 20px;">Mô tả chi tiết</h2>
            <div style="line-height: 1.6;">
                {{ .Content }}
            </div>
        </div>
    </div>

</div>

<script>
    // 1. TẠO DANH SÁCH TẤT CẢ HÌNH ẢNH (Hugo render ra mảng JS)
    const allImages = [
        "{{ .Params.images.main | relURL }}",
        {{ range .Params.images.thumbs }}"{{ . | relURL }}",{{ end }}
    ];

    let slideIndex = 0; // Bắt đầu từ hình đầu tiên (số 0)

    // Hàm khi bấm nút Mũi tên (n là -1 hoặc +1)
    function plusSlides(n) {
        showSlides(slideIndex += n);
    }

    // Hàm khi bấm vào hình nhỏ (Thumbnail)
    function currentSlide(n) {
        showSlides(slideIndex = n);
    }

    // Hàm hiển thị hình ảnh
    function showSlides(n) {
        let mainImg = document.getElementById("main-img");
        let thumbs = document.getElementsByClassName("thumb");

        // Logic vòng lặp: Hết hình thì quay lại đầu
        if (n >= allImages.length) { slideIndex = 0 }
        if (n < 0) { slideIndex = allImages.length - 1 }

        // 1. Đổi hình to
        mainImg.src = allImages[slideIndex];

        // 2. Xử lý viền cam cho hình nhỏ
        for (let i = 0; i < thumbs.length; i++) {
            thumbs[i].className = thumbs[i].className.replace(" active", "");
        }
        // Đảm bảo thumb tồn tại trước khi add class (đề phòng lỗi)
        if (thumbs[slideIndex]) {
            thumbs[slideIndex].className += " active";
        }
    }

    // 2. GIỮ NGUYÊN CODE GIỎ HÀNG CŨ CỦA BẠN
    function addToCart(product) {
        let cart = JSON.parse(localStorage.getItem('myShopCart')) || [];
        let existingItem = cart.find(item => item.id === product.id);
        if (existingItem) { existingItem.quantity += 1; } 
        else { product.quantity = 1; cart.push(product); }
        localStorage.setItem('myShopCart', JSON.stringify(cart));
        
        // Cập nhật số trên icon giỏ hàng nếu có hàm
        
        if (typeof forceUpdateCart === 'function') { forceUpdateCart(); } 
        else if (typeof updateCartCount === 'function') { updateCartCount(); }
        
        alert(`Đã thêm "${product.title}" vào giỏ hàng!`);
    }
</script>

<style>
    /* === SLIDESHOW STYLES === */
    .main-image-wrapper {
        width: 100%;
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
        background: #fff;
    }

    #main-img {
        width: 100%;
        height: auto;
        display: block;
        object-fit: cover;
        transition: opacity 0.3s;
    }

    .thumbnails-wrapper {
        display: flex;
        gap: 10px;
        overflow-x: auto; /* Scroll if too many thumbs */
        padding-bottom: 5px;
    }

    .thumb {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border: 1px solid #eee;
        border-radius: 6px;
        cursor: pointer;
        opacity: 0.6;
        transition: all 0.3s;
    }

    .thumb:hover {
        opacity: 1;
        border-color: #ff5722;
    }

    .thumb.active {
        opacity: 1;
        border: 2px solid #ff5722; /* Highlight active thumb */
    }

    /* === EXISTING STYLES === */
    .warning-box {
        background-color: #fff9e6; border: 1px solid #ffe58f; padding: 15px 20px;
        border-radius: 4px; margin-top: 15px; margin-bottom: 20px;
        font-size: 14px; color: #595959; line-height: 1.6;
    }
    .warning-box strong { color: #ff5722; display: block; font-size: 16px; margin-bottom: 10px; text-transform: uppercase; }
    .warning-box ul { margin: 0; padding-left: 20px; }
    .warning-box li { margin-bottom: 5px; list-style-type: disc; }
    .product-price { font-size: 24px; font-weight: bold; color: #ff5722; margin: 10px 0 20px 0; }
    .price-old { color: #999; text-decoration: line-through; font-size: 18px; margin-left: 10px; font-weight: normal; }
    .add-to-cart-button { background-color: #ff5722; color: white; border: none; padding: 12px 30px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 4px; transition: background 0.3s; }
    .add-to-cart-button:hover { background-color: #e64a19; }
    
    @media (max-width: 768px) {
        .product-content-wrapper { flex-direction: column; }
        .product-images, .product-info-section { width: 100%; min-width: 0; }
    }
</style>
{{ end }}