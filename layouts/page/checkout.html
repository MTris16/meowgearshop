{{ define "main" }}

<div class="checkout-wrapper">
    <div class="container">
        <h1 class="page-title">Thanh toán</h1>
        
        <form id="checkoutForm" onsubmit="handleCheckout(event)">
            <div class="checkout-grid">
                
                <div class="col-info">
                    <h3 class="section-title">Thông tin giao hàng</h3>
                    
                    <div class="form-group">
                        <label>Họ và tên *</label>
                        <input type="text" id="cusName" placeholder="Ví dụ: Nguyễn Văn A" required>
                    </div>

                    <div class="form-group">
                        <label>Email nhận hàng *</label>
                        <input type="email" id="cusEmail" placeholder="Ví dụ: email@gmail.com" required>
                    </div>

                    <div class="form-group">
                        <label>Số điện thoại *</label>
                        <input type="tel" id="cusPhone" placeholder="Ví dụ: 0909123456" required>
                    </div>

                    <div class="form-group">
                        <label>Địa chỉ nhận hàng *</label>
                        <input type="text" id="cusAddress" placeholder="Ví dụ: 123 Đường ABC, Quận 1, TP.HCM" required>
                    </div>

                    <div class="form-group">
                        <label>Ghi chú đơn hàng (Tuỳ chọn)</label>
                        <textarea id="cusNote" rows="3" placeholder="Ví dụ: Giao hàng giờ hành chính..."></textarea>
                    </div>
                </div>

                <div class="col-order">
                    <div class="order-summary-box">
                        <h3 class="section-title">Đơn hàng của bạn</h3>
                        
                        <div id="checkoutCartItems" class="checkout-items"></div>

                        <div class="checkout-total">
                            <span>Tổng cộng:</span>
                            <strong id="checkoutTotalMoney">0₫</strong>
                        </div>

                        <div class="payment-method">
                            <label><input type="radio" name="payment" checked> Thanh toán khi nhận hàng (COD)</label>
                            <label><input type="radio" name="payment"> Chuyển khoản ngân hàng</label>
                        </div>

                        <button type="submit" class="btn-place-order">ĐẶT HÀNG NGAY</button>
                    </div>
                </div>

            </div>
        </form>
    </div>
</div>

<script>
    // 1. TỰ ĐỘNG ĐIỀN THÔNG TIN NẾU ĐÃ ĐĂNG NHẬP (Google Login)
    function autoFillUser() {
        const userStr = localStorage.getItem('user_info');
        if (userStr) {
            const user = JSON.parse(userStr);
            
            // Tự điền Tên
            if (user.name) {
                document.getElementById('cusName').value = user.name;
            }
            
            // Tự điền Email (Nếu có)
            if (user.email) {
                document.getElementById('cusEmail').value = user.email;
                // Có thể làm cho ô email mờ đi để biết là tự điền (tuỳ chọn)
                // document.getElementById('cusEmail').style.backgroundColor = "#e8f0fe";
            }
        }
    }

    // 2. LOAD GIỎ HÀNG
    function loadCheckoutCart() {
        const cart = JSON.parse(localStorage.getItem('myShopCart')) || [];
        const container = document.getElementById('checkoutCartItems');
        const totalEl = document.getElementById('checkoutTotalMoney');
        
        if (cart.length === 0) {
            container.innerHTML = '<p>Giỏ hàng đang trống.</p>';
            totalEl.innerText = '0₫';
            return;
        }

        let total = 0;
        let html = '';

        cart.forEach(item => {
            // Làm sạch giá tiền
            let rawPrice = String(item.price).replace(/\./g, "").replace(/,/g, "").replace(/₫/g, "").replace(/đ/g, "").trim();
            let unitPrice = parseInt(rawPrice) || 0;

            let itemTotal = unitPrice * item.quantity;
            total += itemTotal;
            
            let priceFormatted = new Intl.NumberFormat('vi-VN').format(itemTotal);

            html += `
            <div class="checkout-item">
                <div class="ci-img">
                    <img src="${item.image}" alt="${item.title}">
                    <span class="ci-qty">${item.quantity}</span>
                </div>
                <div class="ci-info">
                    <div class="ci-name">${item.title}</div>
                </div>
                <div class="ci-price">${priceFormatted}₫</div>
            </div>
            `;
        });

        container.innerHTML = html;
        totalEl.innerText = new Intl.NumberFormat('vi-VN').format(total) + '₫';
    }

    // 3. XỬ LÝ ĐẶT HÀNG
    function handleCheckout(e) {
        e.preventDefault();

        const name = document.getElementById('cusName').value;
        const phone = document.getElementById('cusPhone').value;
        const email = document.getElementById('cusEmail').value; // Lấy thêm email
        const address = document.getElementById('cusAddress').value;

        // Giả lập gửi đơn hàng
        alert(`Cảm ơn ${name}!\nĐơn hàng xác nhận sẽ được gửi tới email: ${email}\nChúng tôi sẽ gọi ${phone} để giao hàng tới: ${address}`);
        
        localStorage.removeItem('myShopCart');
        window.location.href = "/"; 
    }

    // CHẠY KHI VÀO TRANG
    document.addEventListener('DOMContentLoaded', () => {
        loadCheckoutCart();
        autoFillUser(); // <--- Gọi hàm tự điền
    });
</script>

<style>
    /* CSS CHO TRANG CHECKOUT */
    .checkout-wrapper { background-color: #f5f5f5; padding: 40px 0; min-height: 600px; }
    .page-title { text-align: center; margin-bottom: 30px; text-transform: uppercase; }
    .checkout-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }
    .col-info, .order-summary-box { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .section-title { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px; text-transform: uppercase; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
    
    /* Input Style */
    .form-group input, .form-group textarea {
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; box-sizing: border-box;
    }
    .form-group input:focus { border-color: #ff5722; }

    /* Cart Items */
    .checkout-item { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .ci-img { position: relative; width: 60px; height: 60px; margin-right: 15px; flex-shrink: 0; }
    .ci-img img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #eee;}
    .ci-qty { position: absolute; top: -8px; right: -8px; background: #666; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    .ci-info { flex: 1; }
    .ci-name { font-size: 14px; font-weight: 500; }
    .ci-price { font-weight: bold; color: #333; }

    .checkout-total { display: flex; justify-content: space-between; font-size: 18px; margin: 20px 0; padding-top: 10px; border-top: 2px solid #eee; }
    .checkout-total strong { color: #ff5722; font-size: 22px; }

    .btn-place-order { width: 100%; background-color: #ff5722; color: white; padding: 15px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-place-order:hover { background-color: #e64a19; }
    .payment-method label { display: block; margin-bottom: 10px; cursor: pointer; }

    @media (max-width: 768px) { .checkout-grid { grid-template-columns: 1fr; } }
</style>

{{ end }}